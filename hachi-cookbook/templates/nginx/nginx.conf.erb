upstream <%= @app_name%> {
  server unix:///opt/<%= @app_name %>/shared/sockets/<%= @app_name%>.sock;
}

server {
  listen 80;
  server_name <%=node.ipaddress%>;
  root /opt/<%= @app_name%>/public;
  client_max_body_size 100M;
  <% unless node[@app_name]['app_serving_assets'] == true %>
  location ~ ^/assets/  {
    expires max;
    root /opt/<%= @app_name %>/public/;
    add_header Cache-Control public;
    add_header ETag "";
    }
  <% end %>

  location / {
    proxy_pass http://<%= @app_name%>;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_send_timeout  120;
    proxy_read_timeout 120;
    proxy_connect_timeout 120;
    send_timeout  120;
  }
  location /nginx_status {
    stub_status on;
    access_log  off;
    allow 10.0.0.0/8;
    deny all;
  }
  location /version {
    default_type "text/html";
    allow 10.0.0.0/8;
    deny all;
  }
}
